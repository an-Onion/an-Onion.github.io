<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dialog (Modal) Pattern 示例</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-base-100 min-h-screen p-8">
  <div class="container mx-auto max-w-4xl">
    <h1 class="text-3xl font-bold mb-8 text-center">Dialog (Modal) Pattern 示例</h1>

    <!-- 示例 1: 设置对话框 -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-4">1. 设置对话框</h2>
      <button 
        class="btn btn-primary" 
        onclick="openDialogWithFocus('settings-dialog')"
      >
        打开设置
      </button>

      <dialog id="settings-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="dialog-title">
        <div class="modal-box">
          <div class="flex justify-between items-start">
            <h2 id="dialog-title" class="text-xl font-bold">设置</h2>
            <button 
              class="btn btn-sm btn-circle btn-ghost" 
              onclick="closeDialogWithReturnFocus('settings-dialog', this)"
              aria-label="关闭"
            >
              ✕
            </button>
          </div>
          
          <div class="mt-4 flex flex-col gap-4">
            <label class="form-control w-full max-w-xs">
              <div class="label">
                <span class="label-text">用户名</span>
              </div>
              <input type="text" id="username-input" placeholder="请输入用户名" class="input input-bordered w-full max-w-xs" />
            </label>
            
            <label class="form-control w-full max-w-xs">
              <div class="label">
                <span class="label-text">邮箱</span>
              </div>
              <input type="email" placeholder="请输入邮箱" class="input input-bordered w-full max-w-xs" />
            </label>
          </div>
          
          <div class="modal-action">
            <button 
              class="btn btn-ghost" 
              onclick="closeDialogWithReturnFocus('settings-dialog', this)"
            >
              取消
            </button>
            <button 
              class="btn btn-primary" 
              onclick="closeDialogWithReturnFocus('settings-dialog', this); alert('设置已保存')"
            >
              保存
            </button>
          </div>
        </div>
        
        <form method="dialog" class="modal-backdrop">
          <button aria-label="关闭" onclick="closeDialogWithReturnFocus('settings-dialog', this)"></button>
        </form>
      </dialog>
    </section>

    <!-- 示例 2: 确认对话框 -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-4">2. 确认对话框</h2>
      <button 
        class="btn btn-secondary" 
        onclick="openDialogWithFocus('confirm-dialog')"
      >
        执行操作
      </button>

      <dialog id="confirm-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
        <div class="modal-box">
          <h2 id="confirm-title" class="text-xl font-bold">确认操作</h2>
          <p class="py-4">确定要执行此操作吗？</p>
          
          <div class="modal-action">
            <form method="dialog" class="flex gap-2">
              <button class="btn btn-ghost" autofocus>取消</button>
              <button class="btn btn-secondary" onclick="alert('操作已执行')">确认</button>
            </form>
          </div>
        </div>
        
        <form method="dialog" class="modal-backdrop">
          <button aria-label="关闭"></button>
        </form>
      </dialog>
    </section>

    <!-- 示例 3: 嵌套对话框 -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-4">3. 嵌套对话框</h2>
      <button 
        class="btn btn-accent" 
        onclick="document.getElementById('layer1').showModal()"
      >
        打开第一层
      </button>

      <!-- 第一层对话框 -->
      <dialog id="layer1" class="modal" role="dialog" aria-modal="true" aria-labelledby="layer1-title">
        <div class="modal-box">
          <h2 id="layer1-title" class="text-xl font-bold">第一层对话框</h2>
          <p class="py-4">这是第一层对话框</p>
          
          <div class="modal-action">
            <form method="dialog" class="flex gap-2">
              <button class="btn btn-ghost" autofocus>关闭</button>
              <button 
                class="btn btn-accent" 
                type="button"
                onclick="openDialogWithFocus('layer2')"
              >
                打开第二层
              </button>
            </form>
          </div>
        </div>
        
        <form method="dialog" class="modal-backdrop">
          <button aria-label="关闭"></button>
        </form>
      </dialog>

      <!-- 第二层对话框 -->
      <dialog id="layer2" class="modal" role="dialog" aria-modal="true" aria-labelledby="layer2-title">
        <div class="modal-box">
          <h2 id="layer2-title" class="text-xl font-bold">第二层对话框</h2>
          <p class="py-4">这是第二层对话框</p>
          
          <div class="modal-action">
            <form method="dialog" class="flex gap-2">
              <button class="btn btn-ghost" autofocus>关闭</button>
            </form>
          </div>
        </div>
        
        <form method="dialog" class="modal-backdrop">
          <button aria-label="关闭"></button>
        </form>
      </dialog>
    </section>

    <!-- 示例 4: 使用 div + ARIA 的自定义实现 -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-4">4. 自定义实现（div + ARIA）</h2>
      <button 
        class="btn btn-info" 
        onclick="openCustomDialog()"
      >
        打开自定义对话框
      </button>

      <div 
        id="custom-dialog" 
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[1000]" 
        role="dialog" 
        aria-modal="true" 
        aria-labelledby="custom-title"
        tabindex="-1"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
          <div class="flex justify-between items-start">
            <h2 id="custom-title" class="text-xl font-bold">自定义对话框</h2>
            <button 
              class="text-gray-500 hover:text-gray-700 text-2xl" 
              onclick="closeCustomDialog(this)"
              aria-label="关闭"
            >
              &times;
            </button>
          </div>
          
          <p class="my-4">这是一个使用 div 元素和 ARIA 属性实现的自定义对话框</p>
          
          <div class="flex justify-end gap-2 mt-4">
            <button class="btn btn-ghost" onclick="closeCustomDialog(this)">取消</button>
            <button class="btn btn-info" onclick="closeCustomDialog(this)">确认</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // 焦点管理函数
    function openDialogWithFocus(dialogId) {
      const dialog = document.getElementById(dialogId);
      dialog.showModal();
      
      // 将焦点设置到对话框内的第一个可聚焦元素
      setTimeout(() => {
        const firstFocusable = dialog.querySelector('input, button, select, textarea, [href], [tabindex]:not([tabindex="-1"])');
        if (firstFocusable) {
          firstFocusable.focus();
        } else {
          // 如果没有找到可聚焦元素，则聚焦到对话框本身
          dialog.focus();
        }
      }, 0);
    }

    function closeDialogWithReturnFocus(dialogId, closingElement) {
      const dialog = document.getElementById(dialogId);
      dialog.close();
      
      // 尝试将焦点返回到触发对话框的元素
      try {
        // 查找触发对话框的按钮
        const triggerButton = Array.from(document.querySelectorAll('button, [onclick]'))
          .find(btn => btn.onclick && btn.onclick.toString().includes(dialogId));
        
        if (triggerButton && typeof triggerButton.focus === 'function') {
          triggerButton.focus();
        }
      } catch (e) {
        // 如果找不到触发元素，不做任何操作
      }
    }

    // 自定义对话框的焦点管理
    function openCustomDialog() {
      const dialog = document.getElementById('custom-dialog');
      dialog.classList.remove('hidden');
      dialog.focus();
      
      // 将焦点设置到第一个可聚焦元素
      const firstFocusable = dialog.querySelector('input, button, select, textarea, [href], [tabindex]:not([tabindex="-1"])');
      if (firstFocusable) {
        firstFocusable.focus();
      }
      
      // 阻止背景内容交互
      document.body.style.overflow = 'hidden';
      
      // 监听 ESC 键
      dialog.addEventListener('keydown', handleEscKey);
    }

    function closeCustomDialog(closingElement) {
      const dialog = document.getElementById('custom-dialog');
      dialog.classList.add('hidden');
      
      // 恢复背景滚动
      document.body.style.overflow = '';
      
      // 尝试将焦点返回到触发元素
      try {
        const triggerButton = Array.from(document.querySelectorAll('button'))
          .find(btn => btn.onclick && btn.onclick.toString().includes('openCustomDialog'));
        if (triggerButton && typeof triggerButton.focus === 'function') {
          triggerButton.focus();
        }
      } catch (e) {
        // 如果找不到触发元素，不做任何操作
      }
      
      // 移除事件监听器
      dialog.removeEventListener('keydown', handleEscKey);
    }

    function handleEscKey(event) {
      if (event.key === 'Escape') {
        closeCustomDialog();
      }
    }

    // 点击背景关闭对话框
    document.getElementById('custom-dialog').addEventListener('click', function(event) {
      if (event.target === this) {
        closeCustomDialog();
      }
    });
  </script>
</body>
</html>