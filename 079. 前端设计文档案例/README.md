# 多语言翻译中心设计文档

如何写一份设计文档，是我们作为程序员，尤其是作为资深工程师，需要掌握的技能。各个公司文档模板各异，但基本用意并不是让你来简单填空的；通常来说，文档模版本身也是被设计成为一个思考问题的框架。

本文以《多语言翻译中心》的设计文档为例，借助我所熟悉的某个公司的框架来展示如何写一份完整的设计文档。其中有设计不当之处，也请大家指正。

## 背景

随着公司业务的快速发展，产品线越来越多，国际化需求也日益增加。为了更好地支持多语言，我们需要一个统一的国际化中心来管理各个产品的本土翻译。本文将提供一个 MVP 版本的实时多语言翻译中心的方案，以解决我们现阶段前端开发中添加多语言所遇到的痛点。

## 问题描述

在展开问题描述前先交代一下现在的架构，如下所示：

![legacy arch.][0]

### 痛点

1. 开发人员每次 onboard 一个新的语言， 需要 2.5 天的开发成本（挖坟，通过记录之前开发人员的时间得到这个数据，比如 5 个 web 服务共花了 13 天）。
2. 即便是简单的一个字段更改，由于冗长的发布流程，我们也需要大约 0。5 天的开发成本，据统计我们整个部门每周都有 3 次这样的需求（还是挖坟，给出 ticket 记录）
3. 翻译虽然简单，但是经手人过多（BO、PO、translator、developer...），从提出需求到最终需求上线要经过多个环节，通常耗时 2.5 天 （给出 PO 的证明）

简单计算人力成本，每月的消耗大约是

$$
2MD \times 3 \times 4 \times \$250 = \$6000
$$

### Root Causes

1. 开发人员只能了解一到两种语言，其他语种对开发来说只能产生负面作用
2. 翻译内容分散在各个项目中，然而各个项目翻译的工具并不相同，需要手动修改不同的资源文件，对于 on-call 的同事来说需要一定的学习成本
3. 合规的开发本质还是缺少弹性，即便是简单又低风险的翻译内容，也不得不陷入到冗长的发布流程中

## 参照系

市面上有多种解决国际化（i18n）需求的方案和工具。以下是一些常见的 i18n 解决方案：

- i18next: 一个广泛使用的国际化框架，并提供收费的中心化翻译管理服务。

- Transifex: 一个在线平台，提供翻译管理和国际化解决方案，支持多种文件格式。

- Phrase。 提供全面的翻译管理解决方案，支持 AI 翻译。

- Lokalise：提供一站式翻译服务，打通业务、设计、开发相关的各个环节。

这些竞品各有优势，但总提来说有以下几个亮点：

1. 提供中心化的翻译管理服务，整合各个项目
2. 提供实时修改，方便业务和开发在线修改翻译内容
3. 集成 AI， 能自动生成多语言，减少人工介入
4. 提供统一的 UI，方便非技术人员使用

当然，这些工具虽好，但是也有一些自身的缺陷，如：价格过高、不兼容我厂开发流程。比如 Lokalise 就曾今来我司推广，但由于这些原因，无疾而终。所以我们选择自研方案，即兼顾上述优点，又可以适配我厂开发流程。

## 方案设计

- MVP 业务功能：

  - 提供一个操作界面，方便业务人员修改翻译内容
  - 提供一个审批页面，帮助为 code owner 审批翻译，并实时发布最新内容
  - 集成 open AI 自动生成中文和韩文的翻译内容

- 非业务功能：

  - 不侵入现有代码逻辑，实现平滑过渡
  - 服务宕机时，不影响现有业务
  - 服务紧急回滚时，可自动切换版本

- 非 MVP 目标： 支持 handlebar 等遗产框架

### 架构设计

![solution arch.][1]

我们部门前端 i8n 工具相对简单，基本用采用的是 react-intl 框架——翻译文件集中在一些 json 文件中，如 en.json 是英语词条，ko.json 就是韩语词条。很适合进行 MVP 验证。

我们的设计方案是：

1. 提供一个零依赖的中心化的服务，上游服务的后端不需要任何修改
2. 开发阶段只保留英文词条，其他词条在编译阶段由 AI 自动生成
3. 通过修改 S3 上的翻译文件来实现 real time 的翻译效果
4. 提供一个 UI 平台，方便非开发人员修改翻译，从而减少 adhoc 的 ticket

#### 代码修改

我们只需对现有的前端代码进行简单的修改，即将翻译内容从同步引入改成异步加载。由于各个翻译的 json 体积都小于 100K，异步加载只会产生零点几秒的延迟，对 B 端用户体验影响不大。

- AS-IS

```js
import messagesInFrench from "./message/en.json";
import messagesInChinese from "./message/zh.json";

function App() {
  const message = locale === "en" ? messagesInEnglish : messagesInChinese;

  return <IntlProvider messages={message}>...</IntlProvider>;
}
```

- TO BE

```js
function App() {
  const [message, setMessage] = useState({});

  useEffect(() => {
    // async import translation based on locale
    fetch(`./message/${locale}.json`).then(setMessage);
  }, [locale]);

  return <IntlProvider messages={message}>...</IntlProvider>;
}
```

### 版本控制

在编译极端，通过 [SHA-256 哈希算法][3]对 en.json 生成一个 contenthash 。它根据文件内容计算哈希值，当文件内容发生变化时（如增加词条）才生成新的哈希。

![CI][5]

这样可以确保相同的内容生成相同的哈希值，并始终映射到同样的 S3 路径上；反之，不同的内容则生成不同的哈希，使得不同版本的内容互不干扰。如下所示，当紧急回滚服务时，由于旧版本的哈希值已嵌入到 nginx 镜像中；所以回滚旧镜像后，可实现自动切换到旧版本的翻译路径上。

![version][4]

### 进一步改造计划

Long term 的 solution 是，开发阶段甚至不需要保留 en.json 文件，直接将英语写入代码中：

```js
export function List(props) {
  const { formatMessage } = useIntl()
  return (
    <header>
      {formatMessage({ defaultMessage="Hello World" })}
    </header>
  )
}
```

在 CI 阶段利用 [formatjs][2] 将代码中的英语提取出来生成 en.json，再进行后续的翻译工作。这样可以进一步提升开发体验。

### 服务器选型

| 方案                              | 优点                                                                                      | 缺点                                                                                                         |
| --------------------------------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| 方案 A：寄生在现有的 admin 服务中 | 1. 无需支付额外的服务器成本，成本只有每月$50 的网络费用； 2. 可以利用现成的 auth 服务鉴权 | 后续推广到其他组织的服务需要另起炉灶                                                                         |
| 方案 B：重新搭建一套新的服务      | 完全独立的服务，可扩展性较强，不会对遗产代码造成负面影响                                  | 1. 需要从头搭建服务，开发成本相对较高；2. 服务器规格需符合公司备灾原则，所以至少需要 6 台 EC2， 大约每月$800 |
| 方案 C：使用 lambda 架构          | lambda 架构按需收费，非常适合我们这样的低频服务，成本每月$10                              | 1. 启动速度较慢；2. 当服务遇到非正常流量访问时（如 DR 测试），服务器费用会激增                               |

## 验证问题解决的指标

- 1. 对单个服务，能将 onboard 一个新语种的时间缩短到 1 天（跟踪国际化团队的 ticket，记录时间）
- 2. 修改翻译内容，实现实时显示
- 3. AI 自动生成翻译内容，并能达到 85% 以上的准确率 （需要定义准确率）
- 4. 服务器宕机时，不影响现有业务
- 5. 服务紧急回滚，可自动切换版本

## MVP 反馈

MVP 成功得到验证，后续将逐步推广到其他部门。

## 小结

本文以《多语言翻译中心 MVP 设计》为例，介绍了如何从零开始设计一个满足业务需求的工具。基本思考框架是：

1. 确定业务背景和痛点（痛点是最难的，老板不吃这一套，后面就不用看下去了）
2. 调研市面上现有的解决方案，并分析其优缺点
3. 根据业务和系统的特性，给出 high level 的设计方案 （本文在这方面有缺陷，最好能给出三个左右的可选方案，再做权衡利弊）
4. 给出核心代码，以及关键问题的解决方案
5. 给出验证方案，以及如何衡量方案的成功
6. 最后交代 MVP 成功后的 long term 计划，以及后续的优化方向

再说说自己写设计的感受吧。虽然本文是个 mock 案例，但是我陆陆续续在下班时间写了两个礼拜的样子，很多章节后来也有所省略。日常工作中，我也会写一些设计文档，但是个人感觉设计文档比代码难写得多。通常，我的设计文档的通过率很低，经常被老板各种 challenge；即便反复打磨，最后可能还是无疾而终。
其实到了一定层级，老板对你的代码根本不屑一看；同样写设计文档也一样，再精妙再详实，也抵不过老板对你的信心。看清生活的本质但依旧热爱生活，其实是我们每一个开发都需要抱有的心态：即便前方困难重重，但是多试几次，你的成功就多一份希望。共勉。

[0]: ./img/legacy.drawio.png
[1]: ./img/solution.drawio.png
[2]: https://formatjs.io/docs/getting-started/message-extraction
[3]: https://en.wikipedia.org/wiki/SHA-2#SHA-256
[4]: ./img/version.drawio.png
[5]: ./img/CI.drawio.png
