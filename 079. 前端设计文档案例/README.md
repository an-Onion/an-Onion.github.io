# 多语言翻译中心设计文档

如何写一份 design review 的 Doc，是我们作为程序员，尤其是作为资深工程师，需要掌握的技能。各个公司通常来说都有自己独有的文档模板；但时模版也不是让你来简单填空的，通常来说文本模版本身是被设计成为解决问题的一个框架。

本文以 i18n Center 的设计文档为例，借助我所熟悉的某个公司的框架展示如何写一份完整的 design review 文档。其中有设计不当之处，也请大家指正。

## 背景

随着公司业务的快速发展，产品线越来越多，国际化需求也日益增加，为了更好地支持国际化，我们需要一个统一的国际化中心，来管理各个产品的国际化需求。本文将提供一个 MVP 版本的实时多语言翻译中心的方案，以解决我们现阶段前端开发中添加多语言所遇到的痛点。

## 问题描述

在展开问题描述前先交代一下现在的架构，如下所示：

![legacy arch.][0]

### Pain Points

1. 开发人员每次 onboard 一个新的 locale 需要 2.5 天的开发成本（挖坟，通过记录之前开发人员的时间得到这个数据，比如 5 个 web 服务共花了 13 天）。
2. 即便是简单的一个字段更改，由于冗长的发布流程，我们也需要大约 0。5 天的开发成本，据统计我们整个部门每周都有 3 次这样的需求（还是挖坟，给出 ticket 记录）
3. 翻译虽然简单，但时经手人过多（BO、PO、translator、developer...），从提出需求到最终需要上线需要经过多个环节，通常需要 2.5 天 （给出 PO 的证明）

简单计算人力成本，每月的消耗大约是

$$
2MD \times 3 \times 4 \times \$250 = \$6000
$$

### Root Causes

1. 开发人员只能懂得一到两种语言，其他语种对开发来说只能产生负面作用
2. 翻译内容分散在各个项目中，每次修改翻译内容，都需要手动修改各个项目中的翻译文件，开发成本较高
3. 合规的开发本质还是缺少弹性，即便是简单又低风险的翻译内容，也不得不陷入到冗长的发布流程中

## 参照系

市面上有多种解决国际化（i18n）需求的方案和工具。以下是一些常见的 i18n 解决方案：

- i18next: 一个广泛使用的国际化框架，并提供收费的中心化翻译管理服务。

- Transifex: 一个在线平台，提供翻译管理和国际化解决方案，支持多种文件格式。

- Phrase。 提供全面的翻译管理解决方案，支持 AI 翻译。

- Lokalise：提供一站式翻译服务，打通业务、设计、开发相关的各个环节。

这些竞品各有优势，但总提来说有以下几个亮点：

1. 提供中心化的翻译管理服务，整合各个项目
2. 提供实时修改，方便业务和开发在线修改翻译内容
3. 集成 AI， 能自动生成多语言，减少人工介入
4. 提供统一的 UI，方便非技术人员使用

## 权衡点

## 方案设计

- MVP 业务功能：

  - 通过一个中心化的服务，为所有前端项目
    提供多语言翻译服务，降低开发成本
  - 提供一个 UI 界面，方便业务和开发实时修改翻译内容
  - 集成 open AI 自动生成中文和韩文的翻译内容

- 非业务功能：
  - 不侵入现有代码逻辑，平滑过渡到 i18n 中心
  - 服务宕机时，不影响现有业务
- 非 MVP 目标：集成公司自研的翻译大模型

### 架构设计

![solution arch.][1]

## 代码修改

我们需要对现有的前端代码进行简单的修改，即将翻译内容（e.g. en.json）从同步引入，改成异步加载。

- AS-IS

```js
import messagesInFrench from "./message/en.json";
import messagesInChinese from "./message/zh.json";

function App() {
  const messages = locale === "en" ? messagesInEnglish : messagesInChinese;

  return <IntlProvider messages={messages}>...</IntlProvider>;
}
```

- TO BE

```js
function App() {
  const [message, setMessage] = useState({});

  useEffect(() => {
    // async import translation based on locale
    fetch(`./message/${locale}.json`).then(setMessage);
  }, [locale]);

  return <IntlProvider messages={message}>...</IntlProvider>;
}
```

### 构建

我们通过 [SHA-256 哈希算法][3]，对 en.json 生成 contenthash 。它根据文件内容计算哈希值，确保当文件内容发生变化时，生成的哈希值也会改变。我们只需要在构建工具 webpack 中，添加简单的配置，即可以在前端工程构建时生成 contenthash，例如：


```js
output: {
  filename: '[contenthash]/[name].json',
}
```

这样可以确保相同的内容始终拥有相同的哈希值，而不同的内容则会生成不同的哈希值。

### Long-term 修改

我们部门前端 i8n 工具相对简单，基本用采用的是 react-intl 框架。Long term 的 solution 是，开发阶段甚至不需要保留 en.json 文件，直接将英语写入代码中：

```js
export function List(props) {
  const { formatMessage } = useIntl()
  return (
    <header>
      {formatMessage({ defaultMessage="Hello World" })}
    </header>
  )
}
```

在 CI 阶段利用 [formatjs][2] 将代码中的英语提取出来，生成 en.json 文件，再进行后续的翻译工作。这样可以进一步提升开发体验。

## 风险评估

### 可选的方案

| 方案                              | 优点                                                                                      | 缺点                                                                                                         |
| --------------------------------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| 方案 A：寄生在现有的 admin 服务中 | 1. 无需支付额外的服务器成本，成本只有每月$50 的网络费用； 2. 可以利用现成的 auth 服务鉴权 | 后续推广到其他组织的服务需要另起炉灶                                                                         |

## 风险评估

### 可选的方案

| 方案                              | 优点                                                                                      | 缺点                                                                                                         |
| --------------------------------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| 方案 A：寄生在现有的 admin 服务中 | 1. 无需支付额外的服务器成本，成本只有每月$50 的网络费用； 2. 可以利用现成的 auth 服务鉴权 | 后续推广到其他组织的服务需要另起炉灶                                                                         |
| 方案 B：重新搭建一套新的服务      | 完全独立的服务，可扩展性较强，不会对遗产代码造成负面影响                                  | 1. 需要从头搭建服务，开发成本相对较高；2. 服务器规格需符合公司备灾原则，所以至少需要 6 台 EC2， 大约每月$800 |
| 方案 C：使用 lambda 架构          | lambda 架构按需收费，非常适合我们这样的低频服务，成本每月$10                              | 1. 启动速度较慢；2. 当服务遇到非正常流量访问时（如 DR 测试），服务器费用会激增                               |

## 验证问题解决的指标

## 方案失败后的应对措施

## 反馈回路

[0]: ./img/legacy.drawio.png
[1]: ./img/solution.drawio.png
[2]: https://formatjs.io/docs/getting-started/message-extraction
[3]: https://en.wikipedia.org/wiki/SHA-2#SHA-256
